#!/bin/bash

set -e

REPO_ROOT=$(git rev-parse --show-toplevel)
cd "$REPO_ROOT" || exit 1

README="${REPO_ROOT}/README.md"

echo "Running pre-push hook..." >&2

# Try to load AOC_SESSION from .env if not already set
if [[ -z "${AOC_SESSION:-}" ]] && [[ -f "${REPO_ROOT}/.env" ]]; then
    source "${REPO_ROOT}/.env"
fi

# Skip if AOC_SESSION not set
if [[ -z "${AOC_SESSION:-}" ]]; then
    echo "Skipping leaderboard update (AOC_SESSION not set)" >&2
    exit 0
fi

# Fetch leaderboard
TABLE=$(./fetch_leaderboard.sh 2>/dev/null)
if [[ -z "${TABLE}" ]]; then
    exit 0
fi

# Remove old Days Completed section if it exists
sed -i '/^# Days Completed$/,/^#/{ /^# Days Completed$/d; /^#/!d; }' "$README"
sed -i '/^# Days Completed$/d' "$README"

# Append new leaderboard to end of README
echo "" >> "$README"
echo "# Days Completed" >> "$README"
echo "" >> "$README"
echo "$TABLE" >> "$README"

# Check if there were changes
if git diff --quiet "$README"; then
    exit 0
fi

git add "$README"
git commit -m "update leaderboard [git hook]"
echo "Updated leaderboard in README.md"
